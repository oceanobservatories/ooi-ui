{% extends "common/base.html" %}

{% block title %}
    <title>Data Catalog</title>
{% endblock %}

{% block head %}
  <link rel="stylesheet" href="/css/compiled/svgplot.css" type="text/css" />
  <!-- Partials -->
  <script src="/js/partials/compiled/svgplot.js" type="text/javascript"></script>
  <!-- lunr needs to be imported by a script tag -->
  <script src="/lib/lunr.js/lunr.js" type="text/javascript"></script>
  <script src="/js/compiled/svgplot.js" type="text/javascript"></script>
{% endblock %}

{%block body %}    

<div id="wrapper">
  <div id="sidebar-wrapper" class="hidden navbar-default">
  </div> <!-- #sidebar-wrapper -->
  <div id="page-content-wrapper">
    <div class="content-fluid">
      <div class="row">
        <div class="col-sm-12">
          <div class="panel">
            <div class="panel-heading">
              <span class="glyphicon glyphicon-hdd" aria-hidden="true"> Data Catalog</span>
              <div class="panel-search pull-right">
                <input id='stream-search' type="text" placeholder="&#xf002; Search">
              </div>
            </div>
            <div class="panel-body">
              <div id="stream-table-view">
                <i class="fa fa-spinner fa-spin" style="margin-left:50%;font-size:90px;color:#337ab7"> </i>
              </div> <!-- #view -->
            </div> <!-- .panel-body -->
          </div> <!-- .panel -->
        </div> <!-- .col -->
      </div> <!-- .row -->      
    </div> <!-- .content-fluid -->  
      </div> <!-- .row -->
      <a href='#bottom-row'></a>
      <div id='bottom-row' class="row">
        <div class="col-sm-8">
          <div class="panel">
            <div class="panel-heading">
              <i class="fa fa-bar-chart-o"> Graph</i>
              <div class="pull-right">
                <div class="dropdown">
                  <a href='#' class='dropdown-toggle' data-toggle='dropdown' aria-expanded='true'>
                    <i class="fa fa-caret-down"></i>
                  </a>
                  <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
                    <li role="presentation"><a id='download-plot' role="menuitem" tabindex="-1" href="#"><i class="fa fa-download"> Download</i></a></li>
                    <li role="presentation"><a id='add-plot' role="menuitem" tabindex="-1" href="#"><i class="fa fa-plus"> Add Plot</i></a></li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="panel-body">
              <div id="plot-view">
                <i class="fa fa-spinner fa-spin" style="margin-left:50%;font-size:90px;color:#337ab7"> </i>
              </div> <!-- #view -->
              <div id="plotcontrols">
              </div>
            </div>
          </div>
        </div>
        <div class="col-sm-4">
          <div id='annotation-panel' class="panel">
            <div class="panel-heading">
              Annotations
            </div>
            <div class="panel-body">
              <div id="annotation-table">
                <i class="fa fa-spinner fa-spin" style="margin-left:50%;font-size:90px;color:#337ab7"> </i>
              </div>
            </div>
          </div>
          <div id='second-plot-panel' class='panel'>
            <div class='panel-heading'>
              <i class="fa fa-bar-chart-o"> Graph</i>
            </div>
            <div class="panel-body">
              <div id="second-plot">
                <i class="fa fa-spinner fa-spin" style="margin-left:50%;font-size:90px;color:#337ab7"> </i>
              </div>
            </div>
          </div>
        </div>
      </div> <!-- .row -->
    </div> <!-- .content-fluid -->
    <div id="annotation-modal">
    </div>
    <div id="stream-download-modal">
    </div>
    <div id='download-ok-modal'></div>
    <div id='download-fail-modal'></div>
  </div> <!-- #page-content-wrapper -->
</div> <!-- #wrapper -->


<script type="text/javascript">

var userId = parseInt(window.location.href.split('/').pop());

_.extend(OOI.prototype, Backbone.Events, {
  login: new LoginModel(),
  collections: {
    annotations: new AnnotationCollection(),
    streams: new StreamCollection()
  },
  views: {
  },
  models: {
    userModel: new UserModel()
  },
  start: function() {
    var self = this;
    this.login.fetch({async: false});
    
    if(this.login.loggedIn()) {
      this.models.userModel.fetch({url: '/api/current_user'});
    }
    
    this.views.navbar = new NavbarView();
    $('body').prepend(this.views.navbar.el);
    this.views.navbar.sidebarToggle();
   
    this.views.streamTableView = new StreamTableView({
      collection: this.collections.streams,
      el: $('#stream-table-view')
    });
    this.views.annotationTableView = new AnnotationTableView({
      collection: this.collections.annotations,
      el: $('#annotation-table')
    });
        
    this.views.streamDownloadFormView = new StreamDownloadFormView({
      el: $('#stream-download-modal')
    });
    this.views.modalDownloadView = new ModalDownloadView({
      el: $('#download-ok-modal')
      });
    this.views.modalDownloadFailView = new ModalDownloadFailView({
      el: $('#download-fail-modal')
      });

    this.collections.annotations.fetch({reset: true});
    this.collections.streams.fetch({reset:true});

    /* Dispatcher Sectiion */
    this.listenTo(this, "login:success", function() { location.reload(); });
    this.listenTo(this, "login:logout", function() { location.reload(); });
    this.listenTo(this, 'StreamTableItemView:onRowClick', function(row) {
      /*
      $('#bottom-row').show();
      jump('bottom-row');
      var model = row.model;
      self.views.svgPlotControlView.setModel(model);
      self.views.svgplot.setModel(model);
      self.collections.annotations.fetch({
        data: $.param({stream_name: model.get('stream_name')}),
        reset: true
      });
      */
      row.focus();

      //get the model
      var ref_des = row.model.get('reference_designator')
      var ref_des_split = ref_des.split("-")
      //get the current location
      if (!location.origin)
        location.origin = location.protocol + "//" + location.host;
      
      //get the parts
      var array = ref_des.substring(0, 2);
      var mooring = ref_des_split[0]
      var platform = ref_des_split[1]
      var instrument = ref_des
      var instrument_url = [array, mooring, platform , instrument].join("/");

      var win = window.open(location.origin+"/plotting/"+instrument_url, '_blank');
      win.focus();


    });
    

    this.listenTo(this, 'AnnotationModalFormView:onSubmit', function(model) {
      console.log("Adding ot collection");
      self.collections.annotations.add(model);
    });
    this.listenTo(this, 'AnnotationTableItemView:onClick', function(model) {
      if(self.login.loggedIn()) {
        self.views.annotationModal.show({
          model: model,
          userModel: self.models.userModel
        });
      }
    });    

    this.listenTo(this, 'ooi:streamSearch', function(searchTerm) {
      if(searchTerm == '') {
        self.views.streamTableView.render();
      } else {
        self.views.streamTableView.search(searchTerm);
        $('#stream-search').val('');
      }
    });
    this.listenTo(this, 'StreamTableItemView:onClick', function(options) {
        
      console.log(options)
    });
    this.listenTo(this, 'DownloadModal:onHide',function(){
        self.views.modalDownloadView.show();
  });
    this.listenTo(this, 'DownloadModalFail:onFail',function(){
        self.views.modalDownloadFailView.show();
  });

}
});

var ooi = new OOI();

$(document).ready(function() {
  ooi.start();
  
  $('#stream-search').keyup(function(e) {
    if(e.keyCode == 13) {
      ooi.trigger('ooi:streamSearch', $(e.target).val());
    }
  });
  $('body').find('#hideTOC').hide()
  
});

function jump(h){
    var url = location.href;               //Save down the URL without hash.
    location.href = "#"+h;                 //Go to the target element.
    history.replaceState(null,null,url);   //Don't like hashes. Changing it back.
}

</script>

{% endblock %}
